apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.superdesk.name }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      component: {{ .Values.superdesk.component }}
  template:
    metadata:
      labels:
        component: {{ .Values.superdesk.component }}
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: instance/type
                operator: NotIn
                values:
                - lb
            - matchExpressions:
              - key: instance/type
                operator: NotIn
                values:
                - storage
            - matchExpressions:
              - key: instance/type
                operator: NotIn
                values:
                - database
      containers:
        - name: client
          image: "{{ .Values.superdesk.image }}:{{ .Values.superdesk.tag }}"
          resources:
            limits:
              cpu: "8"
              memory: 16Gi
            requests:
              cpu: "4"
              memory: 8Gi
          ports:
            - containerPort: 9000
            - containerPort: 5000
            - containerPort: 5100
            - containerPort: 5400
            - containerPort: 443
            - containerPort: 80
          env:
            - name: HOST
              value: "{{ .Values.superdesk.baseUrl }}"
            - name: DB_HOST
              value: "mongodb"
            - name: DB_NAME
              value: "superdesk"
            - name: SUPERDESK_URL
              value: "{{ .Values.proto }}://{{ .Values.superdesk.baseUrl }}/api"
            - name: CONTENTAPI_URL
              value: "{{ .Values.proto }}://{{ .Values.superdesk.baseUrl }}/contentapi"
            - name: SUPERDESK_WS_URL
              value: "wss://{{ .Values.superdesk.baseUrl }}/ws"
            - name: SUPERDESK_CLIENT_URL
              value: "{{ .Values.proto}}://{{ .Values.superdesk.baseUrl }}"
            - name: DOCKER_IP
              value: "superdesk"
            - name: MONGO_URI
              value: "mongodb://mongodb/superdesk"
            - name: LEGAL_ARCHIVE_URI
              value: "mongodb://mongodb/superdesk_la"
            - name: ARCHIVED_URI
              value: "mongodb://mongodb/superdesk_ar"
            - name: ELASTICSEARCH_URL
              value: "http://elastic:9200"
            - name: ELASTICSEARCH_INDEX
              value: "superdesk"
            - name: CONTENTAPI_ELASTICSEARCH_INDEX
              value: "superdesk_ca"
            - name: CONTENTAPI_ELASTIC_INDEX
              value: "superdesk_ca"
            - name: CONTENTAPI_MONGO_URI
              value: "mongodb://mongodb/superdesk_ca"
            - name: REDIS_URL
              value: "redis://redis:6379/1"
            - name: TZ
              value: {{ .Values.timezone | quote }}
            - name: SUPERDESK_CLIENT_CONFIG_FILE
              value: "superdesk-{{ .Values.stage }}.cloud.config.js"
      imagePullSecrets:
        - name: harbor-access
